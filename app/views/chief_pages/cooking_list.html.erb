<div id='notify-list' style="width: 100%;height: 100px"></div>
<div class="col-md-6">
  <h4> Cần làm <label class="label label-danger" id="queue-cooking" > <%= @start_cookings.count %> </label></h4>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th id="num" scope="col">
            #
        </th>
        <th id="com" scope="col">
            <abbr title="Computer Number">Com</abbr>
        </th>
        <th id="State" scope="col">
            Items
        </th>
        <th id="villa" scope="col">
            In charge
        </th>
      </tr>
    </thead>
    <tbody>
      <% @start_cookings.each_with_index do |sale,index| %>
        <tr>
          <td><%= index + 1 %></td>
          <td><%= sale['customer_id'] rescue 0%></td>
          <td>
            <table class="table table-striped">
              <tr>
                <th>Tên</th>
                <th><Description/th>
                <th>Số lượng</th>
              </tr>
              <% sale['sale_menu_items_details'].each_with_index do |item| %>
                <tr>
                  <td><%= item['name']%></td>
                  <td><%= item['description']%></td>
                  <td><%= item['quantity']%></td>
                </tr>
              <% end %>
            </table>
          </td>
          <td>
            <a href="<%= start_cooking_chief_pages_path + '/?sale_id=' + sale['id'].to_s%>" data-remote= "true" type="button" class="btn btn-lg btn-block btn-danger">Băt đầu làm</a>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
<div class="col-md-6">
  <h4> Đang làm <label class="label label-success" id="cooking"> <%= @done_cookings.count %> </label></h4>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th id="num" scope="col">
            #
        </th>
        <th id="com" scope="col">
            <abbr title="Computer Number">Com</abbr>
        </th>
        <th id="State" scope="col">
            Items
        </th>
        <th id="villa" scope="col">
            In charge
        </th>
      </tr>
    </thead>
    <tbody>
      <% @done_cookings.each_with_index do |sale,index| %>
        <tr>
          <td><%= index + 1 %></td>
          <td><%= sale['customer_id'] rescue 0%></td>
          <td>
            <table class="table table-striped">
              <tr>
                <th>Tên</th>
                <th><Description/th>
                <th>Số lượng</th>
              </tr>
              <% sale['sale_menu_items_details'].each_with_index do |item| %>
                <tr>
                  <td><%= item['name']%></td>
                  <td><%= item['description']%></td>
                  <td><%= item['quantity']%></td>
                </tr>
              <% end %>
            </table>
          </td>
          <td>
            <a href="<%= done_cooking_chief_pages_path + '/?sale_id=' + sale['id'].to_s%>" data-remote= "true" type="button" class="btn btn-lg btn-block btn-success">Làm xong</a>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<script>
var staff_channel = dispatcher.subscribe('staff');
var stack_context = {"dir1": "right", "dir2": "down", "push": "bottom", "spacing1": 5, "spacing2": 5,"context": $("#notify-list")}
PNotify.desktop.permission();

staff_channel.bind("next_state_sale",function(data) {
  if(data['sale']['state'] == 'processing') {
    $(function(){
      var notice = new PNotify({
          title: "test",
          text: "Order mới từ máy " + data['sale']['customer_id'],
          animate_speed: "fast",
          width: "250px",
          delay: 500000,
          type: 'info',
          styling: "fontawesome",
          buttons: {sticker: false, closer_hover: false},
          stack: stack_context,
      });
      notice.get().click(function(e) {
        notice.remove();
      });
      $("#queue-cooking").html(parseInt($("#queue-cooking").html()) +1);
      var desktop_notice = new PNotify({
          title: "test",
          text: "Order mới",
          animate_speed: "fast",
          hide: false,
          desktop: {
            desktop: true
          }
      });
      desktop_notice.get().click(function(e) {
        alert('124');
      });
    });
  }
  else if(data['sale']['state'] == "cooking") {
    $(function(){
      var notice = new PNotify({
          title: "test",
          text: "Order " + data['sale']['id'] + " từ máy " + data['sale']['customer_id'] + "đang được làm",
          animate_speed: "fast",
          width: "250px",
          delay: 500000,
          type: 'danger',
          styling: "fontawesome",
          buttons: {sticker: false, closer_hover: false},
          stack: stack_context,
      });
      notice.get().click(function(e) {
        notice.remove();
      });
      // Move from queue-cooking -> cooking table
      $("#queue-cooking").html(parseInt($("#queue-cooking").html()) - 1);
      $("#cooking").html(parseInt($("#cooking").html()) + 1);
    });
  }
  else if(data['sale']['state'] == "done") {
    $(function(){
      var notice = new PNotify({
          title: "test",
          text: "Order " + data['sale']['id'] + " từ máy " + data['sale']['customer_id'] + "làm xong",
          animate_speed: "fast",
          width: "250px",
          delay: 500000,
          type: 'success',
          styling: "fontawesome",
          buttons: {sticker: false, closer_hover: false},
          stack: stack_context,
      });
      notice.get().click(function(e) {
        notice.remove();
      });
      // Move from cooking -> history table
      $("#cooking").html(parseInt($("#cooking").html()) - 1);
    });
  }
});
</script>
