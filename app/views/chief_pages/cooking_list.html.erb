<script type="text/javascript">
var staff_channel = dispatcher.subscribe('staff');
var stack_context = {"dir1": "down", "dir2": "left", "push": "bottom", "spacing1": 5, "spacing2": 5}
</script>
<div class="chef-pages">
  <br>
  <div class="no-orders" style='padding-left: 15px; padding-right: 15px'>
    <div class="alert alert-warning">
      Tạm thời không có ORDER mới
    </div>
    <br>
  </div>
  <div style='padding-left: 15px;'>
    <section id="pinBoot">
      <%= render 'order_cooking' %>
      <%= render 'order_processing' %>
      <%= render 'order_template' %>
    </section>
  </div>
</div>
<script>
$(document).ready(function () {
  check_has_order()
  $('#pinBoot').pinterest_grid({
    no_columns: 3,
    padding_x: 15,
    padding_y: 20,
    margin_bottom: 100,
    single_column_breakpoint: 700
  });
});



$("#pinBoot").on('click', '.order-cooking .service', function(){
  var checked = $(this).children(".row").children(".col-lg-10").children(".check-service-done").prop("checked")

  sale_id = $(this).parents(".order-cooking").attr("sale-id")

  id = $(this).attr('service-id')

  if(checked) {
    $(this).children(".row").children(".col-lg-10").children(".check-service-done").prop('checked', false); 
  }
  else {
    $(this).children(".row").children(".col-lg-10").children(".check-service-done").prop('checked', true); 
  }

  $.ajax({
    type: "GET",
    url: "/chief_pages/done_cooking?sale_menu_id=" + id
  });

  done = true

  $(".order-cooking[sale-id="+sale_id+"] .check-service-done").each( function(){
    if(!$(this).prop("checked"))
      done = false
  })

  if(done){
    $(".order-cooking[sale-id="+sale_id+"]").remove()
    check_has_order()
    $(function(){
      var notice = pop_notify({
        text: "Order " + sale_id + " đã làm xong",
      });
    });
  }
})

$("#pinBoot").on('click', '.btn-done-cooking', function(){
  $(this).parents(".order-cooking").children(".service-lists").children(".col-lg-12").children(".services").children(".service").each(function(){
    id = $(this).attr('service-id')
    $.ajax({
      type: "GET",
      url: "/chief_pages/done_cooking?sale_menu_id=" + id
    });
  })

  $(this).parents(".order-cooking").remove()
  check_has_order()
})

$("#pinBoot").on('click', '.btn-start-cooking', function(){
  sale_id = $(this).attr('sale-id')
  $(".order-processing[sale-id="+sale_id+"]").children(".service-lists").children(".col-lg-12").children(".services").children(".service").each(function(){
    id = $(this).attr('service-id')
    $.ajax({
      type: "GET",
      url: "/chief_pages/start_cooking?sale_menu_id=" + id
    });
  })

  $(".order-processing[sale-id="+sale_id+"] .list-style").remove()
  $(".order-processing[sale-id="+sale_id+"] .service-name").before("<input type='checkbox' class='check-service-done'>")

  $(".order-processing[sale-id="+sale_id+"] .btn-start-cooking").text("Làm Xong")

  $(".order-processing[sale-id="+sale_id+"] .btn-start-cooking").addClass("btn-danger").removeClass("btn-primary")

  $(".order-processing[sale-id="+sale_id+"] .btn-start-cooking").addClass("btn-done-cooking").removeClass("btn-start-cooking")      

  template = $(".order-processing[sale-id="+sale_id+"]").html()

  article = '<article class="order order-cooking" sale-id="'+sale_id+'"></article>'

  $(".order-processing[sale-id="+sale_id+"]").remove()

  if($(".order.order-cooking").length > 0)
    $('.order.order-cooking').last().after(article)
  else
    $("#pinBoot").prepend(article)

  $(".order-cooking[sale-id="+sale_id+"]").html(template)
})

staff_channel.bind("next_state_sale",function(data) {
  if(data['sale']['state'] == 'processing') {
    if(data['sale']['is_food_sale']){
      $(function(){
        var notice = pop_notify({
          text: "Order mới từ máy " + data['sale']['customer_id'],
        });

        append_processing_order(data)
        check_has_order()
      });
    }
  }
});

function append_processing_order(params){
  sale_id = params['sale']['id']
  template = $(".order-template").html()
  article = '<article class="order order-processing" sale-id="'+sale_id+'"></article>'
  $(".order-template").before(article)
  $(".order-processing[sale-id="+sale_id+"]").html(template)
  $(".order-processing[sale-id="+sale_id+"] .sale-name").html("<i class='fa fa-desktop'></i>Máy "+params['sale']['customer_id'])
  $(".order-processing[sale-id="+sale_id+"] .sale-code.sale-created-at").html("MÃ HĐ: "+params['sale']['invoice_number']+"<br>NGÀY: "+params['sale']['format_created_at'])

  $(".order-processing[sale-id="+sale_id+"] .btn-start-cooking").attr("sale-id", sale_id)
  append_service_list(params)
}

function append_service_list(params){
  sale_id = params['sale']['id']
  params['sale']['food_sale_menu_items_details'].forEach(function(data){
    menu_item = data['menu_item_details']

    template = $(".order-processing[sale-id="+sale_id+"] .service-template").html()

    service  = "<li class='service' service-id='"+data['id']+"'></li>"

    $(".order-processing[sale-id="+sale_id+"] .services").append(service)

    $(".order-processing[sale-id="+sale_id+"] .services .service[service-id="+data['id']+"]").html(template)

    $(".order-processing[sale-id="+sale_id+"] .service[service-id="+data['id']+"] .service-name").text(menu_item['name'])
    $(".order-processing[sale-id="+sale_id+"] .service[service-id="+data['id']+"] .service-quantity").text(parseInt(data['quantity']))
    if(data['description'] === null)
      data['description'] = ""
    $(".order-processing[sale-id="+sale_id+"] .service[service-id="+data['id']+"] .service-description").text(data['description'])
  })
  $(".order-processing[sale-id="+sale_id+"] .services .service-template").remove()
}

function check_has_order(){
  order_processing = $(".order.order-processing").length
  order_cooking    = $(".order.order-cooking").length
  if(order_cooking + order_processing == 0){
    $(".no-orders").fadeIn(100)
  }
  else{
    $(".no-orders").fadeOut(100) 
  }
}
</script>
