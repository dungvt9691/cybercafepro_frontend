<table class="table table-bordered table-order-ready table-order">
  <thead>
    <thead>
      <tr>
        <th style="width: 25%">
          <i class='fa fa-desktop' style='font-size: 25px; padding-top: 10px; position: relative'></i>
        </th>
        <th style="width: 75%;">
          Cần giao cho khách
        </th>
      </tr>
    </thead>
  </thead>
  <tbody>
    <% @sales_ready.each do |sale| %>
    <tr class="order-row <%= sale['has_ready_sale_menu_item'] ? 'visible' : 'hidden' %> <%= 'success' if sale['state'] == 'pending' %>" sale-id='<%= sale['id'] %>' id="sale-<%= sale['id'] %>">
      <td class="order-com">
        Máy <%= sale['customer_id'] %>
      </td>
      <td class='order-lists'>
        <table class="table table-bordered">
          <tbody>
            <% sale['food_sale_menu_items_details'].each do |item| %>
            <tr data-target="#item-action-dropdown-<%= item['id'] %>" data-toggle="dropdown" class='menu-item-row <%= get_class_menu_item(item['state']) %>' item-id="<%= item['id'] %>" id="<%= item['id'] %>">
              <td class='menu-item-name'>
                <% if ['done', 'delivering'].include? item['state'] %>
                <div id="item-action-dropdown-<%= item['id'] %>" class="btn-group item-action pull-right" style="margin-top: 12px">
                  <button type="button" style="padding-bottom: 2px;" class="btn btn-sm btn-primary dropdown-toggle" data-toggle="dropdown" role="button" data-target="#item-action-dropdown-<%= item['id'] %>" aria-haspopup="true" aria-expanded="false">
                    <i class='fa fa-caret-down' style='font-size: 18px'></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li class='<%= item['state'] == 'done' ? 'active' : '' %>'>
                      <a class='btn-go_deliver' <%= "data-remote=true" if item['state'] == 'done' %> href="<%= item['state'] == 'done' ? go_deliver_waiter_pages_path(sale_menu_id: item['id']) : 'javascript:;' %>">Đi giao</a>
                    </li>
                    <li class='<%= item['state'] == 'delivering' ? 'active' : '' %>'>
                      <a class='btn-done-deliver' <%= "data-remote=true" if item['state'] == 'delivering' %> href="<%= item['state'] == 'delivering' ? done_deliver_waiter_pages_path(sale_menu_id: item['id']) : 'javascript:;' %>">Đã giao</a>
                    </li>
                  </ul>
                </div>
                <% end %>
                <div class='item-name'>
                  <%= item['menu_item_details']['name'] %>
                  <strong class='item-quantity'>
                    (<%= item['quantity'].to_i %>)
                  </strong>
                </div>
                <small class='pull-left item-action-at' style='font-weight: normal; margin-top: 3px'>
                  <%= get_item_action_at(item) %>
                </small>
              </td>
            </tr>
            <% end %>
            <% sale['drink_sale_menu_items_details'].each do |item| %>
            <tr data-target="#item-action-dropdown-<%= item['id'] %>" data-toggle="dropdown" class='menu-item-row <%= get_class_menu_item(item['state']) %>' item-id="<%= item['id'] %>" id="<%= item['id'] %>">
              <td class='menu-item-name'>
                <% if ['done', 'delivering'].include? item['state'] %>
                <div id="item-action-dropdown-<%= item['id'] %>" class="btn-group item-action pull-right" style="margin-top: 12px">
                  <button type="button" style="padding-bottom: 2px;" class="btn btn-sm btn-primary dropdown-toggle" data-toggle="dropdown" role="button" data-target="#item-action-dropdown-<%= item['id'] %>" aria-haspopup="true" aria-expanded="false">
                    <i class='fa fa-caret-down' style='font-size: 18px'></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li class='<%= item['state'] == 'done' ? 'active' : '' %>'>
                      <a class='btn-go_deliver' <%= "data-remote=true" if item['state'] == 'done' %> href="<%= item['state'] == 'done' ? go_deliver_waiter_pages_path(sale_menu_id: item['id']) : 'javascript:;' %>">Đi giao</a>
                    </li>
                    <li class='<%= item['state'] == 'delivering' ? 'active' : '' %>'>
                      <a class='btn-done-deliver' <%= "data-remote=true" if item['state'] == 'delivering' %> href="<%= item['state'] == 'delivering' ? done_deliver_waiter_pages_path(sale_menu_id: item['id']) : 'javascript:;' %>">Đã giao</a>
                    </li>
                  </ul>
                </div>
                <% end %>
                <div class='item-name'>
                  <%= item['menu_item_details']['name'] %>
                  <strong class='item-quantity'>
                    (<%= item['quantity'].to_i %>)
                  </strong>
                </div>
                <small class='pull-left item-action-at' style='font-weight: normal; margin-top: 3px'>
                  <%= get_item_action_at(item) %>
                </small>
              </td>
            </tr>
            <% end %>
            <% sale['service_sale_menu_items_details'].each do |item| %>
            <tr data-target="#item-action-dropdown-<%= item['id'] %>" data-toggle="dropdown" class='menu-item-row <%= get_class_menu_item(item['state']) %>' item-id="<%= item['id'] %>" id="<%= item['id'] %>">
              <td class='menu-item-name'>
                <% if ['done', 'delivering'].include? item['state'] %>
                <div id="item-action-dropdown-<%= item['id'] %>" class="btn-group item-action pull-right" style="margin-top: 12px">
                  <button type="button" style="padding-bottom: 2px;" class="btn btn-sm btn-primary dropdown-toggle" data-toggle="dropdown" role="button" data-target="#item-action-dropdown-<%= item['id'] %>" aria-haspopup="true" aria-expanded="false">
                    <i class='fa fa-caret-down' style='font-size: 18px'></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li class='<%= item['state'] == 'done' ? 'active' : '' %>'>
                      <a class='btn-go_deliver' <%= "data-remote=true" if item['state'] == 'done' %> href="<%= item['state'] == 'done' ? go_deliver_waiter_pages_path(sale_menu_id: item['id']) : 'javascript:;' %>">Đi giao</a>
                    </li>
                    <li class='<%= item['state'] == 'delivering' ? 'active' : '' %>'>
                      <a class='btn-done-deliver' <%= "data-remote=true" if item['state'] == 'delivering' %> href="<%= item['state'] == 'delivering' ? done_deliver_waiter_pages_path(sale_menu_id: item['id']) : 'javascript:;' %>">Đã giao</a>
                    </li>
                  </ul>
                </div>
                <% end %>
                <div class='item-name'>
                  <%= item['menu_item_details']['name'] %>
                  <strong class='item-quantity'>
                    (<%= item['quantity'].to_i %>)
                  </strong>
                </div>
                <small class='pull-left item-action-at' style='font-weight: normal; margin-top: 3px'>
                  <%= get_item_action_at(item) %>
                </small>
              </td>
            </tr>
            <% end %>
          </tbody>
        </table>
      </td>
    </tr>
    <% end %>
    <tr class="no-ready-orders no-orders">
      <td colspan="4">
        <div class="alert alert-warning">Tạm thời không có order mới.</div>
      </td>
    </tr>
  </tbody>
</table>

<script type="text/javascript">
$(document).ready(function () {
  if($(".table-order-ready .order-row.visible").length > 0){
    $(".notify-order-ready").fadeIn(0)
    $(".no-ready-orders").fadeOut(0)
  }
  else{
    $(".notify-order-ready").fadeOut(0)
    $(".no-ready-orders").fadeIn(0)
  }
});

staff_channel.bind("next_state_sale",function(data) {
  if(data['sale']['state'] == "done") {
    $(function(){
      var notice = pop_notify({
        title: "test",
        text: "Order " + data['sale']['id'] + " từ máy " + data['sale']['customer_id'] + "làm xong",
        stack: stack_context,
      });
      notice.get().click(function(e) {
        notice.remove();
        //move to element
      });
      var desktop_notice = pop_desktop_notify({
        title: "test",
        text: "Order " + data['sale']['id'] + " từ máy " + data['sale']['customer_id'] + "làm xong",
        type: "success",
        stack: stack_context,
      })

      append_ready_order_row(data)
      set_notifications_number()
      set_marquee_notifications_ready(data)
      set_stack_notifications(data, "ready")
      set_display_stack_notifications()
    });
  }
  else if(data['sale']['state'] == "delivering") {
    $(function(){
    });
  }
  else if(data['sale']['state'] == "delivered") {
    $(function(){
    });
  }
});

staff_channel.bind("next_state_sale_menu_item",function(data) {
  sale_item_id = data['sale_menu_item']['id']
  if(data['sale_menu_item']['state'] == "delivering") {
    $(function(){
      var notice = pop_notify({
        title: "test",
        text: "",
        stack: stack_context,
      });
      notice.get().click(function(e) {
        notice.remove();
        //move to element
      });
      var desktop_notice = pop_desktop_notify({
        title: "test",
        text: "",
        type: "success",
        stack: stack_context,
      })

      $(".menu-item-row[item-id="+sale_item_id+"]")
    });
  }
  else if(data['sale_menu_item']['state'] == "delivered") {
    $(function(){
      var notice = pop_notify({
        title: "test",
        text: "",
        stack: stack_context,
      });
      notice.get().click(function(e) {
        notice.remove();
        //move to element
      });
      var desktop_notice = pop_desktop_notify({
        title: "test",
        text: "",
        type: "success",
        stack: stack_context,
      })


    });
  }
});
</script>
