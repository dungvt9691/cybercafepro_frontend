<table class="table table-bordered table-order-pending table-order">
  <thead>
    <tr>
      <th style="width: 15%">
        <div style="font-size: 20px; padding-top: 1px"><i class="fa fa-desktop"></i></div>
      </th>
      <th style="width: 57%">Khách gọi</th>
      <th style="width: 48%">Trạng thái</th>
    </tr>
  </thead>
  <tbody>
    <tr class="no-pending-orders no-orders">
      <td colspan="3">
        <div class="alert alert-warning">Tạm thời không có order mới.</div>
      </td>
    </tr>
  </tbody>
</table>

<script type="text/javascript">
$(document).ready(function () {
  if($(".table-order-pending .order-row").length > 0){
    $(".notify-order-pending").fadeIn(0)
    $(".no-pending-orders").fadeOut(0)
  }
  else{
    $(".notify-order-pending").fadeOut(0)
    $(".no-pending-orders").fadeIn(0)
  }
});

$(".table-order-pending").on('click', '.btn-retrieve', function(){
  $(this).addClass("disabled")
  $(this).siblings(".btn-retrieved").removeClass("disabled")
})

$(".table-order-pending").on('click', '.btn-retrieved', function(){
  sale_id = $(this).parents(".order-row").attr("sale-id")
  $(".notification-text[sale-id="+sale_id+"]").remove()
  $(".notification-content[sale-id="+sale_id+"]").remove()
  $(this).parents(".order-row").remove()
  set_notifications_number()
  set_stack_notifications()
  if($('.table-order-pending .order-row').length == 0)
  {
    $(".no-pending-orders").fadeIn(100)
  }
})

staff_channel.bind("create_sale",function(data) {
  $(function(){
    var notice = pop_notify({
      title: "test",
      text: "Order mới từ máy " + data['sale']['customer_id'],
      type: "success",
      stack: stack_context,
    });
    notice.get().click(function(e) {
      if ($('.ui-pnotify-closer, .ui-pnotify-sticker, .ui-pnotify-closer *, .ui-pnotify-sticker *').is(e.target))
        return;
      $.scrollToElement({to: "#sale-" + data['sale']['id']});
      notice.remove();
      //move to element
    });
    var desktop_notice = pop_desktop_notify({
      title: "test",
      text: "Order mới từ máy " + data['sale']['customer_id'],
      type: "success",
      stack: stack_context,
    })

    append_pending_order_row(data)
    set_notifications_number()
    set_marquee_notifications(data)
    set_stack_notifications()
  });
});

// {"sale"=>
//   {"id"=>2,
//    "invoice_number"=>"INV1435658662",
//    "comment"=>"",
//    "state"=>"init",
//    "customer_id"=>0,
//    "pender_id"=>0,
//    "processor_id"=>0,
//    "chef_id"=>0,
//    "deliverer_id"=>0,
//    "saver_id"=>0,
//    "created_at"=>"2015-06-30T10:04:22.668Z",
//    "updated_at"=>"2015-06-30T10:04:22.668Z",
//    "sale_menu_items_details"=>
//     [{"id"=>3,
//       "name"=>nil,
//       "description"=>nil,
//       "state"=>"init",
//       "quantity"=>"1.0",
//       "tax"=>"0.0",
//       "sale_id"=>2,
//       "menu_item_id"=>4,
//       "pender_id"=>0,
//       "processor_id"=>0,
//       "chef_id"=>0,
//       "deliverer_id"=>0,
//       "saver_id"=>0,
//       "note"=>nil,
//       "created_at"=>"2015-06-30T10:04:22.000Z",
//       "updated_at"=>"2015-06-30T10:04:22.000Z",
//       "sum"=>"10000.0",
//       "next_state"=>"pending",
//       "menu_item_details"=>
//        {"id"=>4,
//         "name"=>"Banh my pate",
//         "description"=>"",
//         "mtype"=>"bread",
//         "unit_price"=>"10000.0",
//         "unit"=>"p",
//         "category_id"=>1,
//         "created_at"=>"2015-06-29T17:12:16.000Z",
//         "updated_at"=>"2015-06-29T17:12:16.000Z",
//         "image"=>
//          {"url"=>"http://123.31.11.135:8080/uploads/menu_item/image/4/55486052-1347938043-image006.jpg"}}},
//      {"id"=>4,
//       "name"=>nil,
//       "description"=>nil,
//       "state"=>"init",
//       "quantity"=>"1.0",
//       "tax"=>"0.0",
//       "sale_id"=>2,
//       "menu_item_id"=>1,
//       "pender_id"=>0,
//       "processor_id"=>0,
//       "chef_id"=>0,
//       "deliverer_id"=>0,
//       "saver_id"=>0,
//       "note"=>nil,
//       "created_at"=>"2015-06-30T10:04:22.000Z",
//       "updated_at"=>"2015-06-30T10:04:22.000Z",
//       "sum"=>"6000.0",
//       "next_state"=>"pending",
//       "menu_item_details"=>
//        {"id"=>1,
//         "name"=>"Cocacola",
//         "description"=>"",
//         "mtype"=>"soft drink",
//         "unit_price"=>"6000.0",
//         "unit"=>"",
//         "category_id"=>2,
//         "created_at"=>"2015-06-29T17:12:15.000Z",
//         "updated_at"=>"2015-06-29T17:12:15.000Z",
//         "image"=>{"url"=>"http://123.31.11.135:8080/uploads/menu_item/image/1/H7R37Fc8_400x400.jpeg"}}}],
//    "next_state"=>"pending"}}

function append_pending_order_row(params){
  params['sale']['com_name'] = "Máy 1"
  element = $(".no-pending-orders")
  element.before("<tr class='order-row' sale-id='"+params['sale']['id']+"' id='sale-"+params['sale']['id']+"'></tr>")

  row_element = $("#sale-"+params['sale']['id'])
  row_element.append("<td class='order-com'><label class='label label-danger'>"+ params['sale']['com_name'] +"</label></td>")
  row_element.append("<td class='order-lists'></td>")
  append_order_list(row_element.children('.order-lists'), params)

  row_element.append("<td class='order-status'></td>")

  order_status_cell = row_element.children(".order-status")

  order_status_cell.append("<button class='btn-retrieve btn btn-primary btn-block'>Đi lấy tiền</button>")
  order_status_cell.append("<center><i class='fa fa-caret-down' style='font-size: 30px'></i></center>")
  order_status_cell.append("<button class='btn-retrieved btn btn-primary disabled btn-block'>Đã lấy tiền</button>")

  $(".table-order-pending .no-orders").fadeOut(0)
}

function append_order_list(element, params){
  element.append("<div class='customer-table'></div>")
  table = "<table><thead><tr><th data-field='id' data-align='left'>MÓN ĂN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</th><th data-field='price' data-align='left'>ĐƠN GIÁ&nbsp; &nbsp; &nbsp;</th><th data-field='name' data-align='left'>SL &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th></tr></thead><tbody></tbody></table>"
  element.children(".customer-table").append(table)

  height = 36;
  total_price = 0;
  params['sale']['sale_menu_items_details'].forEach(function(data){
    menu_item = data['menu_item_details']
    height = height + 59;
    if(height > 390)
      height = 390
    total_price += parseInt(data['sum'])
    append_data = "<tr id='row-service-"+data['id']+"' menu-item-id='"+data['id']+"' class='row-service'><td class='order-service-name'><b>"+ menu_item['name'] +"</b><br><p class='note-for-service'>"+data['description']+"</p></td><td class='order-service-price' data-price='"+parseInt(menu_item['unit_price'])+"'>"+ number_format(menu_item['unit_price']) +"</td><td class='order-service-quantity'><span class='quantity-text'>"+parseInt(data['quantity'])+"</span></td></tr>"
    element.children(".customer-table").children("table").children("tbody").append(append_data)
  })

  element.children(".customer-table").children("table").bootstrapTable({
    height: height
  });

  element.append("<div class='col-lg-12' style='border-top: 1px solid #ccc'><div class='pull-right' style='margin-right: 3px'><h3 style='margin-top: 10px'>Tổng: <span class='total-price'>"+number_format(total_price)+"</span> đ</h3></div></div>")
}

function set_marquee_notifications(params){
  params['sale']['com_name'] = "Máy 1"
  marquee_text = '<span sale-id="'+ params['sale']['id'] +'" class="notification-text">'+ params['sale']['com_name'] +' vừa có order, kiểm tra và thu tiền</span>'
  $('.marquee-notifications-text').append(marquee_text)
}

function set_notifications_number(){
  notifications_number = $(".table-order-pending .order-row").length
  if(notifications_number > 0)
  {
    $(".notify-order-pending").fadeIn(0)
    $(".notify-order-pending").text(notifications_number)
  }
  else{
    $(".notify-order-pending").fadeOut(0)
  }
}

function set_stack_notifications(){
  notifications_number = $(".table-order-pending .order-row").length
  if(notifications_number > 0)
  {
    $(".panel-notification-body").html("")
    $(".panel-notifications").removeClass("minimize")
    $(".panel-notifications").addClass("active")
    $(".table-order-pending .order-row").each(function(){
      com_name = $(this).children(".order-com").children("label").text()
      sale_id  = $(this).attr("sale_id")
      append_data = "<div sale-id='"+sale_id+"' class='notification-content'><div class='row'><div class='col-lg-3 col-md-3 col-sm-3 no-padding'><center><i class='fa fa-desktop'></i><br><label class='label label-primary computer-name'>"+ com_name +"</label></center></div><div class='col-lg-9 col-md-9 col-sm-9 no-padding'><div class='alert alert-info'>Có <b>ORDER MỚI</b>, kiểm tra và <b>thu tiền</b> của khách.</div></div></div></div>"
      $(".panel-notification-body").append(append_data)
    })
  }
  else{
    $(".panel-notifications").addClass("minimize")
    $(".panel-notifications").removeClass("active")
  }
}
</script>
